---
layout: post
title: Safe roguelike programming in Java
date: '2016-02-01T11:30:00.001-08:00'
author: smelC
tags: 
modified_time: '2016-02-01T11:30:06.147-08:00'
blogger_id: tag:blogger.com,1999:blog-989893979829990763.post-1485804573936230612
blogger_orig_url: https://hgamesdev.blogspot.com/2016/02/safe-roguelike-programming-in-java.html
---

<p>While <a href="https://twitter.com/hgamesdev/status/692310541998637057">continuing to code water</a>, I extended the number of places where I use a very handful programming pattern for roguelikes. In roguelikes, you typically have many items to which you can assign categories. So far so good. The difficulty is to keep track of the peculiarities and interaction between these items, <strong>when you add such items regularly</strong>. To make sure I never miss an update when I add a new item, I have such a method in my <code>Item</code> interface:</p> <pre style="" class="prettyprint prettyprinted"><code class="language-java"><span class="kwd">public</span><span class="pln"> </span><span class="typ">ItemKind</span><span class="pln"> getItemKind</span><span class="pun">();</span><span class="pln"><br /><br /></span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">enum</span><span class="pln"> </span><span class="typ">ItemKind</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />  ARMOR</span><span class="pun">,</span><span class="pln"><br />  WEAPON</span><span class="pun">,</span><span class="pln"><br />  BOMB</span><span class="pun">,</span><span class="pln"><br />  POTION</span><span class="pun">,</span><span class="pln"><br />  RUNIC<br /></span><span class="pun">}</span><span class="pln"> </span></code></pre> <p>So when I need to do something item-specific, I switch on the item’s kind, <strong>without using a default case</strong>, as follows:</p> <pre style="" class="prettyprint prettyprinted"><code class="language-java"><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">item</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />  </span><span class="kwd">case</span><span class="pln"> ARMOR</span><span class="pun">:</span><span class="pln"> </span><span class="pun">...</span><span class="pln"><br />  </span><span class="kwd">case</span><span class="pln"> WEAPON</span><span class="pun">:</span><span class="pln"> </span><span class="pun">..</span><span class="pln"><br />  </span><span class="kwd">case</span><span class="pln"> BOMB</span><span class="pun">:</span><span class="pln"> </span><span class="pun">...</span><span class="pln"><br />  </span><span class="kwd">case</span><span class="pln"> POTION</span><span class="pun">:</span><span class="pln"> </span><span class="pun">...</span><span class="pln"><br />  </span><span class="kwd">case</span><span class="pln"> RUNIC</span><span class="pun">:</span><span class="pln"> </span><span class="pun">...</span><span class="pln"><br />  </span><span class="com">/* Hey no default */</span><span class="pln"><br /></span><span class="pun">}</span></code></pre> <p>Hence, when I later add <strong>a new item kind</strong>, I’ll get a warning in the code above, that the <em>switch</em> is incomplete and I’ll be forced to think what to do with the new item kind. I’m so fond of this pattern, that it is used everywhere, hence the interface <code>Weapon</code> that extends <code>Item</code> has its own <code>WeaponKind</code> that encompasses <em>Dungeon Mercenary</em>’s melee weapons (sword, falchion, great axe, etc.). Here’s an example of nested <code>switch</code>s (first item kind, then armor kind):</p> <p><img src="http://i.imgur.com/bk0W5Jw.png" alt="Nested switchs" title=""></p> <p>A subtler usage of this pattern is to time-robust condition testing. Before adding water to <em>Dungeon Mercenary</em>, I did not have an enumeration for the kind of terrain. So I had wall cells, that cannot receive water; and <em>stackable</em> cells that can receive liquids, items, grass. Because I didn’t want to cast a cell to a wall or a <em>stackable</em> lot, I added a method <code>hasLiquid()</code> to the interface common to walls and <em>stackable</em>. It was error-prone regarding extensions, because, even if I change <em>stackable</em>’s <code>hasLiquid</code>’s implementation when adding a new terrain; I didn’t have support to tell me to check all callers of <code>hasLiquid</code>. To exemplify this, consider the following code, that I used to place items on the map:</p> <pre style="" class="prettyprint prettyprinted"><code class="language-java"><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> placeItems</span><span class="pun">(</span><span class="pln">RNG stable</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Collection</span><span class="pun">&lt;?</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">Item</span><span class="pun">&gt;</span><span class="pln"> items</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />    </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">IStackedGridElements</span><span class="pun">[][]</span><span class="pln"> map </span><span class="pun">=</span><span class="pln"> grid</span><span class="pun">.</span><span class="pln">getMap</span><span class="pun">();</span><span class="pln"><br />    </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Iterator</span><span class="pun">&lt;?</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">Item</span><span class="pun">&gt;</span><span class="pln"> it </span><span class="pun">=</span><span class="pln"> items</span><span class="pun">.</span><span class="pln">iterator</span><span class="pun">();</span><span class="pln"><br />    nextItem</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">it</span><span class="pun">.</span><span class="pln">hasNext</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />        </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Item</span><span class="pln"> next </span><span class="pun">=</span><span class="pln"> it</span><span class="pun">.</span><span class="pln">next</span><span class="pun">();</span><span class="pln"><br />        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">next </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"><br />            </span><span class="kwd">continue</span><span class="pun">;</span><span class="pln"><br />        </span><span class="kwd">int</span><span class="pln"> frustration </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br />        </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">frustration </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">32</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />            </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Coord</span><span class="pln"> c </span><span class="pun">=</span><span class="pln"> stable</span><span class="pun">.</span><span class="pln">getRandomElement</span><span class="pun">(</span><span class="pln">monstersWalkables</span><span class="pun">);</span><span class="pln"><br />            </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">IStackedGridElements</span><span class="pln"> sge </span><span class="pun">=</span><span class="pln"> map</span><span class="pun">[</span><span class="pln">c</span><span class="pun">.</span><span class="pln">x</span><span class="pun">][</span><span class="pln">c</span><span class="pun">.</span><span class="pln">y</span><span class="pun">];</span><span class="pln"><br />            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">sge</span><span class="pun">.</span><span class="pln">isWall</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">!</span><span class="pln">sge</span><span class="pun">.</span><span class="pln">isDoor</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">!</span><span class="pln">sge</span><span class="pun">.</span><span class="pln">hasLiquid</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />                </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">IStackedGridElements</span><span class="pun">.</span><span class="typ">Stackable</span><span class="pln"> stack </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">IStackedGridElements</span><span class="pun">.</span><span class="typ">Stackable</span><span class="pun">)</span><span class="pln"> sge</span><span class="pun">;</span><span class="pln"><br />                </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">stack</span><span class="pun">.</span><span class="pln">getOnFloor</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />                    </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">IStackedGridElements</span><span class="pun">.</span><span class="typ">Stackable</span><span class="pln"> novel </span><span class="pun">=</span><span class="pln"> stack</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> next</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">);</span><span class="pln"><br />                    grid</span><span class="pun">.</span><span class="pln">set</span><span class="pun">(</span><span class="pln">c</span><span class="pun">.</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">.</span><span class="pln">y</span><span class="pun">,</span><span class="pln"> novel</span><span class="pun">);</span><span class="pln"><br />                    </span><span class="typ">Global</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="typ">SquidTags</span><span class="pun">.</span><span class="pln">GENERATION</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Placed a "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> next </span><span class="pun">+</span><span class="pln"> </span><span class="str">" at "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> c</span><span class="pun">);</span><span class="pln"><br />                    </span><span class="kwd">continue</span><span class="pln"> nextItem</span><span class="pun">;</span><span class="pln"><br />                </span><span class="pun">}</span><span class="pln"><br />                </span><span class="com">/* fallback can happen */</span><span class="pln"><br />            </span><span class="pun">}</span><span class="pln"><br />            </span><span class="com">/* else should not happen */</span><span class="pln"><br /><br />            frustration</span><span class="pun">++;</span><span class="pln"><br />        </span><span class="pun">}</span><span class="pln"><br />    </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">}</span></code></pre> <p>This code was really unsafe extension-wise. What if I add a new kind of wall later on ? such as a wall that accepts items (a rack). Certainly the test <code>isWall()</code> would be true for the rack (since you cannot walk on it) but it’d rule out the rack for receiving a generated item. The same goes for <code>hasLiquid</code>. When I added water, I added <em>deep water</em> and <em>shallow water</em>. In deep water, the rogue swims, while he walks normally in shallow water. Items can be generated in shallow water, but not in deep water. Hence the test <code>hasLiquid</code> had to be made more precise.</p> <p>After using the enumeration pattern, here’s the revisited version of this code:</p>   <pre style="" class="prettyprint prettyprinted"><code class="language-java"><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> placeItems</span><span class="pun">(</span><span class="pln">RNG stable</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Collection</span><span class="pun">&lt;?</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">Item</span><span class="pun">&gt;</span><span class="pln"> items</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />    </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">IStackedGridElements</span><span class="pun">[][]</span><span class="pln"> map </span><span class="pun">=</span><span class="pln"> grid</span><span class="pun">.</span><span class="pln">getMap</span><span class="pun">();</span><span class="pln"><br />    </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Iterator</span><span class="pun">&lt;?</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">Item</span><span class="pun">&gt;</span><span class="pln"> it </span><span class="pun">=</span><span class="pln"> items</span><span class="pun">.</span><span class="pln">iterator</span><span class="pun">();</span><span class="pln"><br />    nextItem</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">it</span><span class="pun">.</span><span class="pln">hasNext</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />        </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Item</span><span class="pln"> next </span><span class="pun">=</span><span class="pln"> it</span><span class="pun">.</span><span class="pln">next</span><span class="pun">();</span><span class="pln"><br />        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">next </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"><br />            </span><span class="kwd">continue</span><span class="pun">;</span><span class="pln"><br />        </span><span class="kwd">int</span><span class="pln"> frustration </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br />        </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">frustration </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">32</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />            </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Coord</span><span class="pln"> c </span><span class="pun">=</span><span class="pln"> stable</span><span class="pun">.</span><span class="pln">getRandomElement</span><span class="pun">(</span><span class="pln">monstersWalkables</span><span class="pun">);</span><span class="pln"><br />            </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">IStackedGridElements</span><span class="pln"> sge </span><span class="pun">=</span><span class="pln"> map</span><span class="pun">[</span><span class="pln">c</span><span class="pun">.</span><span class="pln">x</span><span class="pun">][</span><span class="pln">c</span><span class="pun">.</span><span class="pln">y</span><span class="pun">];</span><span class="pln"><br />            </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">sge</span><span class="pun">.</span><span class="pln">getTerrainKind</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />            </span><span class="kwd">case</span><span class="pln"> CHEST</span><span class="pun">:</span><span class="pln"><br />            </span><span class="kwd">case</span><span class="pln"> DOOR</span><span class="pun">:</span><span class="pln"><br />            </span><span class="kwd">case</span><span class="pln"> SHALLOW_WATER</span><span class="pun">:</span><span class="pln"><br />            </span><span class="kwd">case</span><span class="pln"> STAIR_DOWN</span><span class="pun">:</span><span class="pln"><br />            </span><span class="kwd">case</span><span class="pln"> STAIR_UP</span><span class="pun">:</span><span class="pln"><br />            </span><span class="kwd">case</span><span class="pln"> WALL</span><span class="pun">:</span><span class="pln"><br />            </span><span class="kwd">case</span><span class="pln"> DEEP_WATER</span><span class="pun">:</span><span class="pln"><br />                frustration</span><span class="pun">++;</span><span class="pln"><br />                </span><span class="kwd">continue</span><span class="pun">;</span><span class="pln"><br />            </span><span class="kwd">case</span><span class="pln"> EMPTY</span><span class="pun">:</span><span class="pln"><br />            </span><span class="kwd">case</span><span class="pln"> GRASS</span><span class="pun">:</span><span class="pln"><br />                </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">IStackedGridElements</span><span class="pun">.</span><span class="typ">Stackable</span><span class="pln"> stack </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">IStackedGridElements</span><span class="pun">.</span><span class="typ">Stackable</span><span class="pun">)</span><span class="pln"> sge</span><span class="pun">;</span><span class="pln"><br />                </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">stack</span><span class="pun">.</span><span class="pln">getOnFloor</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />                    </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">IStackedGridElements</span><span class="pun">.</span><span class="typ">Stackable</span><span class="pln"> novel </span><span class="pun">=</span><span class="pln"> stack</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> next</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">);</span><span class="pln"><br />                    grid</span><span class="pun">.</span><span class="pln">set</span><span class="pun">(</span><span class="pln">c</span><span class="pun">.</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">.</span><span class="pln">y</span><span class="pun">,</span><span class="pln"> novel</span><span class="pun">);</span><span class="pln"><br />                    </span><span class="typ">Global</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="typ">SquidTags</span><span class="pun">.</span><span class="pln">GENERATION</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Placed a "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> next </span><span class="pun">+</span><span class="pln"> </span><span class="str">" at "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> c</span><span class="pun">);</span><span class="pln"><br />                    </span><span class="kwd">continue</span><span class="pln"> nextItem</span><span class="pun">;</span><span class="pln"><br />                </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />                    frustration</span><span class="pun">++;</span><span class="pln"><br />                    </span><span class="kwd">continue</span><span class="pun">;</span><span class="pln"><br />                </span><span class="pun">}</span><span class="pln"><br />            </span><span class="pun">}</span><span class="pln"><br />            </span><span class="kwd">throw</span><span class="pln"> </span><span class="typ">Utils</span><span class="pun">.</span><span class="pln">newUnmatchedISE</span><span class="pun">(</span><span class="pln">sge</span><span class="pun">.</span><span class="pln">getTerrainKind</span><span class="pun">());</span><span class="pln"><br />        </span><span class="pun">}</span><span class="pln"><br />    </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">}</span></code></pre> <p>This code is superior in different ways: the fallback in the previous version (<code>/* fallback can happen */</code>) has been removed, the code is clearer, and it is safe w.r.t. extensions. The day I had lava, I’ll obviously extend the terrain’s enumeration, hence the compiler will create a warning in this code, and I’ll think <em>items in lava ? nah no way</em>. Of course, for this pattern to work, you need to be able to write an enumeration that isn’t too wide (do I want to make a difference between fresh grass and trampled grass in the terrain’s enumeration ? -&gt; No I don’t it’s just a display thing (trampled grass has a darker green)), otherwise you’ll have huge switchs; and you need to be able to come up with an enumeration that will be useful, i.e. where you’ll effectively do different stuff in the different cases.</p> <blockquote>  <p>Written with <a href="https://stackedit.io/">StackEdit</a>.</p></blockquote>